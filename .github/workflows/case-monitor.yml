name: Case Monitor

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  monitor-cases:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Get Puppeteer version
      id: puppeteer-version
      run: |
        echo "version=$(node -p "require('./package.json').dependencies.puppeteer")" >> $GITHUB_OUTPUT
    
    - name: Cache Puppeteer browser
      uses: actions/cache@v4
      with:
        path: ~/.cache/puppeteer
        key: ${{ runner.os }}-puppeteer-${{ steps.puppeteer-version.outputs.version }}
        restore-keys: |
          ${{ runner.os }}-puppeteer-
    
    - name: Install dependencies
      run: npm ci
      env:
        PUPPETEER_SKIP_DOWNLOAD: 'false'
    
    - name: Run case monitor
      env:
        DOCTOR1_USERNAME: ${{ secrets.DOCTOR1_USERNAME }}
        DOCTOR1_PASSWORD: ${{ secrets.DOCTOR1_PASSWORD }}
        DOCTOR2_USERNAME: ${{ secrets.DOCTOR2_USERNAME }}
        DOCTOR2_PASSWORD: ${{ secrets.DOCTOR2_PASSWORD }}
        CI: 'true'
      run: node case-monitor.js
    
    - name: Process alert files
      id: process_alerts
      run: |
        # Find all alert files and process them
        COMBINED_MESSAGE=""
        TOTAL_CASES=0
        DOCTORS_WITH_CASES=""
        
        for alert_file in alert-status-*.json; do
          if [ -f "$alert_file" ]; then
            echo "Processing $alert_file"
            
            HAS_CASES=$(cat "$alert_file" | jq -r '.hasCases')
            CASES_FOUND=$(cat "$alert_file" | jq -r '.casesFound')
            DOCTOR_NAME=$(cat "$alert_file" | jq -r '.doctorName')
            MESSAGE=$(cat "$alert_file" | jq -r '.formattedMessage')
            
            echo "Doctor: $DOCTOR_NAME"
            echo "Has cases: $HAS_CASES"
            echo "Cases found: $CASES_FOUND"
            
            if [ "$HAS_CASES" = "true" ]; then
              TOTAL_CASES=$((TOTAL_CASES + CASES_FOUND))
              if [ -n "$DOCTORS_WITH_CASES" ]; then
                DOCTORS_WITH_CASES="${DOCTORS_WITH_CASES}, ${DOCTOR_NAME}"
                COMBINED_MESSAGE="${COMBINED_MESSAGE}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n${MESSAGE}"
              else
                DOCTORS_WITH_CASES="${DOCTOR_NAME}"
                COMBINED_MESSAGE="${MESSAGE}"
              fi
            fi
          fi
        done
        
        # Save combined message to file
        if [ -n "$COMBINED_MESSAGE" ]; then
          echo -e "$COMBINED_MESSAGE" > combined-email-body.txt
          echo "has_alerts=true" >> $GITHUB_OUTPUT
          echo "total_cases=${TOTAL_CASES}" >> $GITHUB_OUTPUT
          echo "doctors=${DOCTORS_WITH_CASES}" >> $GITHUB_OUTPUT
        else
          echo "has_alerts=false" >> $GITHUB_OUTPUT
          echo "total_cases=0" >> $GITHUB_OUTPUT
          echo "No alerts to send"
        fi
    
    - name: Send combined email alert
      if: steps.process_alerts.outputs.has_alerts == 'true'
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.SMTP_SERVER }}
        server_port: ${{ secrets.SMTP_PORT }}
        username: ${{ secrets.SMTP_USERNAME }}
        password: ${{ secrets.SMTP_PASSWORD }}
        subject: "ðŸš¨ Teleradyx Cases Alert - ${{ steps.process_alerts.outputs.doctors }} - ${{ steps.process_alerts.outputs.total_cases }} Total Cases"
        body: file://combined-email-body.txt
        to: danialkafeel@gmail.com, mohdusman586@gmail.com, deepu004147@gmail.com, mohdusaid53@gmail.com
        from: Teleradyx Case Monitor
        content_type: text/plain
    
    - name: Commit case history files
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add case-history-*.csv
        git diff --staged --quiet || git commit -m "Update case counts for all doctors [skip ci]"
        git push
